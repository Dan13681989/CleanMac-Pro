#!/bin/bash
# CleanMac Pro - Smart Cache Cleaning
# Targeted cache cleaning based on real usage patterns

set -e

echo "ðŸ§¹ CleanMac Pro - Smart Cache Cleaning"
echo "======================================"

# Create backup directory
BACKUP_DIR="/tmp/cleanmac_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "ðŸ“¦ Creating safety backup in $BACKUP_DIR..."

# Function to safely remove with backup
safe_remove() {
    local target=$1
    local description=$2
    
    if [ -d "$target" ] || [ -f "$target" ]; then
        echo "ðŸ”§ Cleaning: $description"
        # Copy to backup then remove contents (not directory)
        cp -r "$target" "$BACKUP_DIR/" 2>/dev/null || true
        # Remove contents but keep directory structure
        find "$target" -mindepth 1 -exec rm -rf {} \; 2>/dev/null || true
    fi
}

echo ""
echo "ðŸ—‘ï¸  Cleaning system caches..."

# System caches - only remove contents, not directories
echo "ðŸ”§ Cleaning: User Library Caches"
find "$HOME/Library/Caches" -mindepth 1 -maxdepth 1 -exec rm -rf {} \; 2>/dev/null || true

# Browser caches (major space savers)
safe_remove "$HOME/Library/Caches/Google/Chrome" "Google Chrome Cache"
safe_remove "$HOME/Library/Caches/com.apple.Safari" "Safari Cache" 
safe_remove "$HOME/Library/Caches/Mozilla" "Firefox Cache"

# Development caches
safe_remove "$HOME/.npm/_logs" "npm Logs"
safe_remove "$HOME/.cache" "User Cache Directory"

# Homebrew cache
if command -v brew &> /dev/null; then
    echo "ðŸº Cleaning Homebrew cache..."
    brew cleanup
fi

echo ""
echo "âœ… Smart cache cleaning completed!"
echo "ðŸ“¦ Backup created at: $BACKUP_DIR"
echo "ðŸ’¾ Space recovered: $(du -sh "$BACKUP_DIR" 2>/dev/null | cut -f1 || echo 'unknown')"
